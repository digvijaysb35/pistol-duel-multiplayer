<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pistol Duel</title>

<style>
body { margin:0; background:#444; overflow:hidden; font-family:Arial; }
canvas { display:block; margin:auto; border:6px solid #777; border-radius:14px; background:#000; }

/* HOME */
#homeBtn {
  position:fixed;
  top:10px;
  left:10px;
  width:38px;
  height:38px;
  border-radius:8px;
  border:none;
  background:#222;
  color:#fff;
  font-size:20px;
  z-index:10;
}

/* MENU */
#menu {
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.9);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  gap:14px;
  z-index:5;
}
.section {
  background:#111;
  padding:16px;
  border-radius:10px;
  width:260px;
}
input, button {
  width:100%;
  padding:10px;
  margin-top:6px;
  font-size:16px;
}
.map-btn { background:#333; }
.map-btn.active { background:#00aaff; }

/* OVERLAY */
#overlay {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:44px;
  color:#fff;
  pointer-events:none;
  white-space:pre-line;
  z-index:3;
}

/* REMATCH */
#rematch {
  position:absolute;
  left:50%;
  top:65%;
  transform:translateX(-50%);
  padding:8px 18px;
  font-size:14px;
  border:none;
  border-radius:6px;
  background:#00aaff;
  color:#fff;
  display:none;
  width:auto;
  z-index:4;
}
#rematchStatus {
  position:absolute;
  left:50%;
  top:72%;
  transform:translateX(-50%);
  font-size:14px;
  color:#ccc;
  display:none;
  z-index:4;
}

/* HEALTH */
#healthUI {
  position:fixed;
  top:12px;
  right:12px;
  display:flex;
  align-items:center;
  gap:6px;
  z-index:10;
}
.health-label { font-size:12px; color:#fff; opacity:.8; }
.health-bar {
  width:60px;
  height:8px;
  background:rgba(255,255,255,.25);
  border-radius:4px;
  overflow:hidden;
}
.health-fill {
  height:100%;
  width:100%;
  background:#00ff88;
  transition:width .2s linear;
}
</style>
</head>

<body>

<button id="homeBtn">⌂</button>

<div id="menu">
  <div class="section">
    <h3>Create Room</h3>
    <input id="cRoom" placeholder="Room code">
    <button class="map-btn active" onclick="sel('zeroG')">Zero-G</button>
    <button class="map-btn" onclick="sel('moon')">Moon</button>
    <button class="map-btn" onclick="sel('ocean')">Ocean</button>
    <button onclick="create()">Create</button>
  </div>
  <div class="section">
    <h3>Join Room</h3>
    <input id="jRoom" placeholder="Room code">
    <button onclick="join()">Join</button>
  </div>
</div>

<div id="overlay"></div>
<button id="rematch">Rematch</button>
<div id="rematchStatus"></div>

<div id="healthUI">
  <div class="health-label">HP</div>
  <div class="health-bar"><div class="health-fill"></div></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const healthFill = document.querySelector(".health-fill");

canvas.width = 420;
canvas.height = innerHeight - 20;

const ws = new WebSocket("wss://pistol-duel-multiplayer.onrender.com");

let state = null;
let myPlayer = null;
let rematchSent = false;
let inMenu = true;
let mapSel = "zeroG";

const overlay = document.getElementById("overlay");
const rematchBtn = document.getElementById("rematch");
const rematchStatus = document.getElementById("rematchStatus");
document.getElementById("homeBtn").onclick = () => location.reload();

/* AUDIO */
const ac = new (window.AudioContext||webkitAudioContext)();
const beep=(f,d)=>{const o=ac.createOscillator(),g=ac.createGain();
o.frequency.value=f;g.gain.setValueAtTime(.12,ac.currentTime);
g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+d);
o.connect(g).connect(ac.destination);o.start();o.stop(ac.currentTime+d);}
const shot=()=>beep(180,.07);
const hit=()=>beep(320,.1);
const win=()=>beep(520,.12);

/* MENU */
function sel(m){
  mapSel=m;
  document.querySelectorAll(".map-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}
function create(){
  ws.send(JSON.stringify({type:"create",room:cRoom.value,map:mapSel}));
}
function join(){
  ws.send(JSON.stringify({type:"join",room:jRoom.value}));
}

/* INPUT */
canvas.onclick=()=>{
  if(state?.started && !state.gameOver){
    ac.resume();
    ws.send(JSON.stringify({type:"shoot"}));
  }
};
rematchBtn.onclick=()=>{
  if(rematchSent) return;
  ws.send(JSON.stringify({type:"rematch"}));
  rematchSent=true;
  rematchBtn.style.display="none";
  rematchStatus.style.display="block";
  rematchStatus.innerText="Waiting for opponent…";
};

/* WS */
ws.onmessage=e=>{
  const d=JSON.parse(e.data);

  if(d.type==="joined"){
    myPlayer=d.player;
  }

  if(d.type==="state"){
    const prev=state;
    state=d.state;

    if(state.startAt && inMenu){
      inMenu=false;
      document.getElementById("menu").style.display="none";
    }

    if(prev){
      if(state.bullets.length>prev.bullets.length) shot();
      if(
        state.players.blue.health<prev.players.blue.health ||
        state.players.white.health<prev.players.white.health
      ) hit();
      if(!prev.gameOver && state.gameOver) win();
    }

    if(prev && prev.gameOver && !state.gameOver){
      rematchSent=false;
      rematchStatus.style.display="none";
    }
  }
};

/* DRAW */
function bg(){
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);
}
function gun(g,c){
  ctx.save();
  ctx.translate(g.x,g.y);
  ctx.rotate(g.angle);
  ctx.fillStyle=c;
  ctx.fillRect(-20,-8,40,16);
  ctx.fillRect(-8,8,12,18);
  ctx.restore();
}

function loop(){
  if(inMenu || !state){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    requestAnimationFrame(loop);
    return;
  }

  bg();
  gun(state.players.blue,"#00aaff");
  gun(state.players.white,"#ff4444");

  state.bullets.forEach(b=>{
    ctx.fillStyle=b.owner==="blue"?"#00aaff":"#ff4444";
    ctx.beginPath();
    ctx.arc(b.x,b.y,3,0,Math.PI*2);
    ctx.fill();
  });

  if(!state.started && !state.gameOver){
    if(state.startAt){
      const t=Math.ceil((state.startAt-Date.now())/1000);
      overlay.innerText=t>0?`${state.map.name}\n${t}`:"GO!";
    } else {
      overlay.innerText="Waiting for opponent…";
    }
  } else overlay.innerText="";

  if(state.gameOver){
    overlay.innerText=state.winner===myPlayer?"YOU WIN":"YOU LOSE";
    if(!rematchSent) rematchBtn.style.display="block";
  }

  const me=state.players[myPlayer];
  if(me){
    const p=Math.max(0,me.health/3)*100;
    healthFill.style.width=p+"%";
    healthFill.style.background=p>66?"#00ff88":p>33?"#ffaa00":"#ff4444";
  }

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
