<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pistol Duel</title>

<style>

  #healthUI {
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 10;
}

.health-label {
  font-size: 12px;
  color: #fff;
  opacity: 0.8;
}

.health-bar {
  width: 60px;
  height: 8px;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  overflow: hidden;
}

.health-fill {
  height: 100%;
  width: 100%;
  background: #00ff88;
  transition: width 0.2s linear;
}
  
body {
  margin:0;
  background:#444;
  overflow:hidden;
  font-family:Arial;
}
canvas {
  display:block;
  margin:auto;
  border:6px solid #777;
  border-radius:14px;
  background:#000;
}

/* HOME */
#homeBtn {
  position:fixed;
  top:10px;
  left:10px;
  width:38px;
  height:38px;
  border-radius:8px;
  border:none;
  background:#222;
  color:#fff;
  font-size:20px;
  z-index:10;
}

/* MENU */
#menu {
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  gap:14px;
}
.section {
  background:#111;
  padding:16px;
  border-radius:10px;
  width:260px;
}
input, button {
  width:100%;
  padding:10px;
  margin-top:6px;
  font-size:16px;
}
.map-btn { background:#333; }
.map-btn.active { background:#00aaff; }

/* OVERLAY */
#overlay {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:44px;
  color:#fff;
  pointer-events:none;
  white-space:pre-line;
}

/* REMATCH */
#rematch {
  position:absolute;
  left:50%;
  top:65%;
  transform:translateX(-50%);
  padding:8px 18px;
  font-size:14px;
  border:none;
  border-radius:6px;
  background:#00aaff;
  color:#fff;
  display:none;
  width:auto;
}
#rematchStatus {
  position:absolute;
  left:50%;
  top:72%;
  transform:translateX(-50%);
  font-size:14px;
  color:#ccc;
  display:none;
}
</style>
</head>

<body>

<button id="homeBtn">⌂</button>

<div id="menu">
  <div class="section">
    <h3>Create Room</h3>
    <input id="cRoom" placeholder="Room code">
    <button class="map-btn active" onclick="sel('zeroG')">Zero-G</button>
    <button class="map-btn" onclick="sel('moon')">Moon</button>
    <button class="map-btn" onclick="sel('ocean')">Ocean</button>
    <button onclick="create()">Create</button>
  </div>
  <div class="section">
    <h3>Join Room</h3>
    <input id="jRoom" placeholder="Room code">
    <button onclick="join()">Join</button>
  </div>
</div>

<div id="overlay"></div>
<button id="rematch">Rematch</button>
<div id="rematchStatus"></div>
  <div id="healthUI">
  <div class="health-label">HP</div>
  <div class="health-bar">
    <div class="health-fill"></div>
  </div>
  </div>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
  const healthFill = document.querySelector(".health-fill");
canvas.width = 420;
canvas.height = innerHeight - 20;

const ws = new WebSocket("wss://pistol-duel-multiplayer.onrender.com");

let state = null;
let prevState = null;
let mapSel = "zeroG";
let myPlayer = null;
let rematchSent = false;
  let inMenu = true;

const overlay = document.getElementById("overlay");
const rematchBtn = document.getElementById("rematch");
const rematchStatus = document.getElementById("rematchStatus");
document.getElementById("homeBtn").onclick = () => location.reload();

// ===== AUDIO =====
const ac = new (window.AudioContext||webkitAudioContext)();

function shotSound(){
  const o=ac.createOscillator(), g=ac.createGain();
  o.type="square"; o.frequency.value=180;
  g.gain.setValueAtTime(.12,ac.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.07);
  o.connect(g).connect(ac.destination);
  o.start(); o.stop(ac.currentTime+.07);
}

function hitSound(){
  const o=ac.createOscillator(), g=ac.createGain();
  o.type="sawtooth"; o.frequency.value=320;
  g.gain.setValueAtTime(.1,ac.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.1);
  o.connect(g).connect(ac.destination);
  o.start(); o.stop(ac.currentTime+.1);
}

function winSound(){
  const o=ac.createOscillator(), g=ac.createGain();
  o.type="triangle"; o.frequency.value=520;
  g.gain.setValueAtTime(.15,ac.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.12);
  o.connect(g).connect(ac.destination);
  o.start(); o.stop(ac.currentTime+.12);
}

// ===== MENU =====
function sel(m){
  mapSel=m;
  document.querySelectorAll(".map-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}
function create(){
  ws.send(JSON.stringify({type:"create",room:cRoom.value,map:mapSel}));
}
function join(){
  ws.send(JSON.stringify({type:"join",room:jRoom.value}));
}

// ===== INPUT =====
canvas.onclick=()=>{
  if(state?.started && !state.gameOver){
    ac.resume();
    ws.send(JSON.stringify({type:"shoot"}));
  }
};
rematchBtn.onclick=()=>{
  if(rematchSent) return;
  ws.send(JSON.stringify({type:"rematch"}));
  rematchSent=true;
  rematchBtn.style.display="none";
  rematchStatus.style.display="block";
  rematchStatus.innerText="Waiting for opponent…";
};

// ===== WS =====
ws.onmessage=e=>{
  const d=JSON.parse(e.data);

  if(d.type==="joined"){
  myPlayer = d.player;
  inMenu = false;
  document.getElementById("menu").style.display = "none";
  }

  if(d.type==="state"){
    if(state){
      if(d.state.bullets.length>state.bullets.length) shotSound();

      // detect hit (health drop)
      if(
        d.state.players.blue.health < state.players.blue.health ||
        d.state.players.white.health < state.players.white.health
      ){
        hitSound();
      }

      // detect game over
      if(!state.gameOver && d.state.gameOver){
        winSound();
      }

      // reset UI on new match
      if(state.gameOver && !d.state.gameOver){
        rematchSent=false;
        rematchStatus.style.display="none";
      }
    }
    prevState=state;
    state=d.state;
  }
};

// ===== DRAW =====
function bg(b){
  ctx.fillStyle=b==="space"?"#000":b==="moon"?"#222":"#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function gun(g, base){
  ctx.save();
  ctx.translate(g.x, g.y);
  ctx.rotate(g.angle);

  const dark = base === "#ff4444" ? "#cc3333" : "#0077aa";
  const darker = base === "#ff4444" ? "#992222" : "#005577";

  // main body
  ctx.fillStyle = base;
  ctx.fillRect(-20, -8, 40, 16);

  // slide
  ctx.fillStyle = dark;
  ctx.fillRect(-18, -11, 36, 6);

  // barrel
  ctx.fillStyle = darker;
  ctx.fillRect(20, -3, 16, 6);

  // muzzle hole
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.arc(36, 0, 2, 0, Math.PI * 2);
  ctx.fill();

  // grip
  ctx.fillStyle = darker;
  ctx.fillRect(-8, 8, 12, 18);

  // grip lines
  ctx.strokeStyle = "rgba(0,0,0,0.4)";
  for (let i = 0; i < 4; i++) {
    ctx.beginPath();
    ctx.moveTo(-6, 10 + i * 4);
    ctx.lineTo(2, 10 + i * 4);
    ctx.stroke();
  }

  // highlight
  ctx.strokeStyle = "rgba(255,255,255,0.25)";
  ctx.beginPath();
  ctx.moveTo(-18, -6);
  ctx.lineTo(16, -6);
  ctx.stroke();

  ctx.restore();
  }

function loop(){
  if (inMenu || !state) {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    requestAnimationFrame(loop);
    return;
    }

  bg(state.map.background);

  gun(state.players.blue,"#00aaff");
  gun(state.players.white,"#ff4444");

  state.bullets.forEach(b=>{
    ctx.fillStyle=b.owner==="blue"?"#00aaff":"#ff4444";
    ctx.beginPath();
    ctx.arc(b.x,b.y,3,0,Math.PI*2);
    ctx.fill();
  });

  if (
  !state.started &&
  !state.gameOver &&
  state.startAt &&
  state.startAt > Date.now() - 5000
){
  const t = Math.ceil((state.startAt - Date.now()) / 1000);
  overlay.innerText = t > 0 ? `${state.map.name}\n${t}` : "GO!";
} else if (!state.started && !state.gameOver) {
  overlay.innerText = "Waiting for opponent…";
    }
  } else overlay.innerText="";

  if(state.gameOver){
    overlay.innerText=state.winner===myPlayer?"YOU WIN":"YOU LOSE";
    if(!rematchSent) rematchBtn.style.display="block";
  }
if (state && myPlayer) {
  const me = state.players[myPlayer];
  const percent = Math.max(0, me.health / 3) * 100;
  healthFill.style.width = percent + "%";
  healthFill.style.background =
    percent > 66 ? "#00ff88" :
    percent > 33 ? "#ffaa00" :
                   "#ff4444";
    }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
